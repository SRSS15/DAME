package it.unisannio.srss.ame;

import java.io.File;
import java.io.IOException;
import java.lang.ProcessBuilder.Redirect;
import java.nio.file.Files;
import java.util.ArrayList;
import java.util.List;

// "/home/danilo/git/androidmalwareengine/AndroidMalwareEngine/tools/HelloWorld/AndroidManifest.xml"
// "/home/ermanno/git/androidmalwareengine/AndroidMalwareEngine/tools/HelloWord//AndroidManifest.xml"
public class AndroidMalwareEngine {

	public final static String APKTOOL = "tools/apktool";

	public static void main(String[] args) throws InterruptedException,
			IOException {

		String apk = "HelloWorld.apk"; // args[0];
		File apkFile = null;
		if (apk == null || !(apkFile = new File(apk)).canRead()) {
			System.err.println("APK not found!");
			System.exit(1);
			return;
		}

		File tmpDir = Files.createTempDirectory("srss").toFile();
		// tmpDir.deleteOnExit();
		ProcessBuilder pb = new ProcessBuilder(APKTOOL, "d", "-f", "-o"
				+ tmpDir.getAbsolutePath(), apkFile.getAbsolutePath());
		pb.redirectOutput(Redirect.INHERIT);
		pb.redirectError(Redirect.INHERIT);
		Process p = pb.start();
		p.waitFor();

		List<String> perms = new ArrayList<String>();
		perms.add("android.permission.READ_SMS");
		perms.add("android.permission.WRITE_EXTERNAL_STORAGE");
		perms.add("android.permission.READ_PHONE_STATE");
		// Non trova il file!
		String manifest = tmpDir.getAbsolutePath() + "/AndroidManifest.xml";

		ManifestManipulator manipulator = new ManifestManipulator(new File(
				manifest));
		manipulator.addPermissions(perms);
		manipulator.writeOutputManifest();
	}
}
